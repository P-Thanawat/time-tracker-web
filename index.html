<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Time Tracker</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        font-weight: 300;
        margin-bottom: 10px;
      }

      .header p {
        opacity: 0.9;
        font-size: 1.1em;
      }

      .controls {
        padding: 30px;
        border-bottom: 1px solid #eee;
      }

      .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 50px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn-danger {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
      }

      .btn-danger:hover {
        box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
      }

      .btn-success {
        background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
        box-shadow: 0 4px 15px rgba(81, 207, 102, 0.3);
      }

      .btn-success:hover {
        box-shadow: 0 6px 20px rgba(81, 207, 102, 0.4);
      }

      .btn-warning {
        background: linear-gradient(135deg, #ffd93d 0%, #ffb700 100%);
        color: #333;
        box-shadow: 0 4px 15px rgba(255, 217, 61, 0.3);
      }

      .btn-warning:hover {
        box-shadow: 0 6px 20px rgba(255, 217, 61, 0.4);
      }

      .tasks-container {
        padding: 30px;
      }

      .task-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
      }

      .task-card:hover {
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
      }

      .task-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .task-title {
        font-size: 1.4em;
        font-weight: 600;
        color: #333;
      }

      .task-actions {
        display: flex;
        gap: 10px;
      }

      .task-actions .btn {
        padding: 8px 16px;
        font-size: 14px;
      }

      .task-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 15px;
      }

      .timer-display {
        font-size: 2em;
        font-weight: 700;
        color: #667eea;
        text-align: center;
        margin: 15px 0;
      }

      .time-stats {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
      }

      .time-stats h4 {
        margin-bottom: 10px;
        color: #495057;
      }

      .time-entry {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
        border-bottom: 1px solid #dee2e6;
      }

      .time-entry:last-child {
        border-bottom: none;
      }

      .total-time {
        font-weight: 700;
        font-size: 1.2em;
        color: #667eea;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        backdrop-filter: blur(5px);
      }

      .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal-content {
        background: white;
        border-radius: 20px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        transform: scale(0.7);
        transition: transform 0.3s ease;
      }

      .modal.show .modal-content {
        transform: scale(1);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
      }

      .modal-title {
        font-size: 1.8em;
        font-weight: 600;
        color: #333;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #999;
        transition: color 0.3s ease;
      }

      .close-btn:hover {
        color: #333;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #495057;
      }

      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 15px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        font-size: 16px;
        transition: border-color 0.3s ease;
      }

      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
      }

      .form-group textarea {
        resize: vertical;
        min-height: 100px;
      }

      .modal-actions {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        margin-top: 30px;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
      }

      .empty-state h3 {
        margin-bottom: 15px;
        font-size: 1.8em;
      }

      .empty-state p {
        font-size: 1.1em;
        margin-bottom: 30px;
      }

      .running-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        background: #51cf66;
        border-radius: 50%;
        margin-right: 10px;
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .status-running {
        background: #d4edda;
        color: #155724;
      }

      .status-stopped {
        background: #f8d7da;
        color: #721c24;
      }

      @media (max-width: 768px) {
        .task-info {
          grid-template-columns: 1fr;
        }

        .task-header {
          flex-direction: column;
          gap: 15px;
        }

        .task-actions {
          flex-wrap: wrap;
          justify-content: center;
        }
      }
    </style>
    <script src="env.js"></script>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Time Tracker</h1>
        <p>Manage your tasks and track time efficiently</p>
      </div>

      <div class="controls">
        <button class="btn" onclick="openModal('taskModal')">
          + Add New Task
        </button>
      </div>

      <div class="tasks-container" id="tasksContainer">
        <!-- Tasks will be rendered here -->
      </div>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="modalTitle">Add New Task</h2>
          <button class="close-btn" onclick="closeModal('taskModal')">
            &times;
          </button>
        </div>
        <form id="taskForm">
          <div class="form-group">
            <label for="taskTitle">Task Title</label>
            <input type="text" id="taskTitle" name="title" required />
          </div>
          <div class="form-group">
            <label for="taskDescription">Description</label>
            <textarea
              id="taskDescription"
              name="description"
              placeholder="Optional description..."
            ></textarea>
          </div>
          <div class="modal-actions">
            <button
              type="button"
              class="btn btn-danger"
              onclick="closeModal('taskModal')"
            >
              Cancel
            </button>
            <button type="submit" class="btn btn-success" id="saveTaskBtn">
              Save Task
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      class TimeTracker {
        constructor() {
          this.tasks = [];
          this.currentTaskId = null;
          this.editingTaskId = null;
          this.timers = new Map();
          this.init();
        }

        async getTasks() {
          try {
            const response = await fetch(`${window.ENV.API_BASE_URL}/tasks`);
            const tasks = await response.json();
            return tasks;
          } catch (error) {
            console.error("Error fetching tasks:", error);
          }
        }

        async init() {
          this.tasks = (await this.getTasks()) || [];
          this.renderTasks();
          this.setupEventListeners();
          this.restoreActiveTimers();
        }

        setupEventListeners() {
          document
            .getElementById("taskForm")
            .addEventListener("submit", (e) => {
              e.preventDefault();
              this.saveTask();
            });
        }

        restoreActiveTimers() {
          this.tasks.forEach((task) => {
            if (task.isRunning && task.startTime) {
              this.startTimer(task.id, task.startTime);
            }
          });
        }

        generateId() {
          return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        saveTask() {
          const title = document.getElementById("taskTitle").value.trim();
          const description = document
            .getElementById("taskDescription")
            .value.trim();

          if (!title) {
            alert("Please enter a task title");
            return;
          }

          if (this.editingTaskId) {
            // Update existing task
            const task = this.tasks.find((t) => t.id === this.editingTaskId);
            if (task) {
              task.title = title;
              task.description = description;
              task.updatedAt = new Date().toISOString();
            }
          } else {
            // Create new task
            const newTask = {
              id: this.generateId(),
              title,
              description,
              totalTime: 0,
              timeEntries: [],
              isRunning: false,
              startTime: null,
              currentSession: 0,
              createdAt: new Date().toISOString(),
              updatedAt: new Date().toISOString(),
            };
            this.tasks.push(newTask);
          }

          this.saveTasks();
          this.renderTasks();
          this.closeModal("taskModal");
          this.resetForm();
        }

        editTask(taskId) {
          const task = this.tasks.find((t) => t.id === taskId);
          if (!task) return;

          this.editingTaskId = taskId;
          document.getElementById("modalTitle").textContent = "Edit Task";
          document.getElementById("taskTitle").value = task.title;
          document.getElementById("taskDescription").value =
            task.description || "";
          document.getElementById("saveTaskBtn").textContent = "Update Task";
          this.openModal("taskModal");
        }

        deleteTask(taskId) {
          if (confirm("Are you sure you want to delete this task?")) {
            if (this.timers.has(taskId)) {
              clearInterval(this.timers.get(taskId));
              this.timers.delete(taskId);
            }
            this.tasks = this.tasks.filter((t) => t.id !== taskId);
            this.deleteTaskHandler(taskId);
            this.saveTasks();
            this.renderTasks();
          }
        }

        startTimer(taskId, startTime = null) {
          const task = this.tasks.find((t) => t.id === taskId);
          if (!task) return;

          // Stop any other running timers
          this.tasks.forEach((t) => {
            if (t.isRunning && t.id !== taskId) {
              this.stopTimer(t.id);
            }
          });

          const actualStartTime = startTime || Date.now();
          task.isRunning = true;
          task.startTime = actualStartTime;
          task.currentSession = startTime ? task.currentSession || 0 : 0;

          const timer = setInterval(() => {
            task.currentSession = Date.now() - actualStartTime;
            this.updateTaskDisplay(taskId);
          }, 1000);

          this.timers.set(taskId, timer);
          this.saveTasks();
          this.renderTasks();
        }

        stopTimer(taskId) {
          const task = this.tasks.find((t) => t.id === taskId);
          if (!task || !task.isRunning) return;

          const sessionTime = task.currentSession || 0;

          if (sessionTime > 0) {
            task.totalTime += sessionTime;
            task.timeEntries.push({
              startTime: new Date(task.startTime).toISOString(),
              endTime: new Date().toISOString(),
              duration: sessionTime,
            });
          }

          task.isRunning = false;
          task.startTime = null;
          task.currentSession = 0;

          if (this.timers.has(taskId)) {
            clearInterval(this.timers.get(taskId));
            this.timers.delete(taskId);
          }

          this.saveTasks();
          this.renderTasks();
        }

        updateTaskDisplay(taskId) {
          const displayElement = document.getElementById(`timer-${taskId}`);
          if (displayElement) {
            const task = this.tasks.find((t) => t.id === taskId);
            if (task && task.isRunning) {
              displayElement.textContent = this.formatTime(task.currentSession);
            }
          }
        }

        formatTime(milliseconds) {
          const totalSeconds = Math.floor(milliseconds / 1000);
          const hours = Math.floor(totalSeconds / 3600);
          const minutes = Math.floor((totalSeconds % 3600) / 60);
          const seconds = totalSeconds % 60;

          if (hours > 0) {
            return `${hours.toString().padStart(2, "0")}:${minutes
              .toString()
              .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
          } else {
            return `${minutes.toString().padStart(2, "0")}:${seconds
              .toString()
              .padStart(2, "0")}`;
          }
        }

        formatDate(dateString) {
          const date = new Date(dateString);
          return date.toLocaleDateString() + " " + date.toLocaleTimeString();
        }

        renderTasks() {
          const container = document.getElementById("tasksContainer");

          if (this.tasks.length === 0) {
            container.innerHTML = `
                        <div class="empty-state">
                            <h3>No tasks yet</h3>
                            <p>Create your first task to start tracking time</p>
                            <button class="btn" onclick="openModal('taskModal')">+ Add Your First Task</button>
                        </div>
                    `;
            return;
          }

          container.innerHTML = this.tasks
            .map(
              (task) => `
                    <div class="task-card">
                        <div class="task-header">
                            <div>
                                <h3 class="task-title">${task.title}</h3>
                                ${
                                  task.isRunning
                                    ? '<span class="running-indicator"></span>'
                                    : ""
                                }
                                <span class="status-badge ${
                                  task.isRunning
                                    ? "status-running"
                                    : "status-stopped"
                                }">
                                    ${task.isRunning ? "Running" : "Stopped"}
                                </span>
                            </div>
                            <div class="task-actions">
                                <button class="btn btn-success" onclick="timeTracker.${
                                  task.isRunning ? "stopTimer" : "startTimer"
                                }('${task.id}')">
                                    ${task.isRunning ? "Stop" : "Start"}
                                </button>
                                <button class="btn btn-warning" onclick="timeTracker.editTask('${
                                  task.id
                                }')">Edit</button>
                                <button class="btn btn-danger" onclick="timeTracker.deleteTask('${
                                  task.id
                                }')">Delete</button>
                            </div>
                        </div>

                        ${
                          task.description
                            ? `<p style="margin-bottom: 15px; color: #6c757d;">${task.description}</p>`
                            : ""
                        }

                        <div class="timer-display" id="timer-${task.id}">
                            ${this.formatTime(task.currentSession)}
                        </div>

                        <div class="task-info">
                            <div class="time-stats">
                                <h4>Total Time</h4>
                                <div class="total-time">${this.formatTime(
                                  task.totalTime
                                )}</div>
                            </div>
                            <div class="time-stats">
                                <h4>Time Entries (${
                                  task.timeEntries.length
                                })</h4>
                                <div style="max-height: 150px; overflow-y: auto;">
                                    ${
                                      task.timeEntries.length > 0
                                        ? task.timeEntries
                                            .map(
                                              (entry) => `
                                        <div class="time-entry">
                                            <span>${this.formatDate(
                                              entry.startTime
                                            )}</span>
                                            <span>${this.formatTime(
                                              entry.duration
                                            )}</span>
                                        </div>
                                    `
                                            )
                                            .join("")
                                        : '<p style="color: #6c757d; font-style: italic;">No time entries yet</p>'
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                `
            )
            .join("");
        }

        openModal(modalId) {
          document.getElementById(modalId).classList.add("show");
        }

        closeModal(modalId) {
          document.getElementById(modalId).classList.remove("show");
          if (modalId === "taskModal") {
            this.resetForm();
          }
        }

        resetForm() {
          document.getElementById("taskForm").reset();
          this.editingTaskId = null;
          document.getElementById("modalTitle").textContent = "Add New Task";
          document.getElementById("saveTaskBtn").textContent = "Save Task";
        }

        saveTasks() {
          fetch(`${window.ENV.API_BASE_URL}/tasks/batch`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(this.tasks),
          });
        }

        deleteTaskHandler(id) {
          fetch(`${window.ENV.API_BASE_URL}/tasks/${id}`, {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
          });
        }
      }

      // Global functions for HTML onclick events
      function openModal(modalId) {
        timeTracker.openModal(modalId);
      }

      function closeModal(modalId) {
        timeTracker.closeModal(modalId);
      }

      // Initialize the app
      const timeTracker = new TimeTracker();

      // Close modal when clicking outside
      document.addEventListener("click", (e) => {
        if (e.target.classList.contains("modal")) {
          e.target.classList.remove("show");
          if (e.target.id === "taskModal") {
            timeTracker.resetForm();
          }
        }
      });
    </script>
  </body>
</html>
